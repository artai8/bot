name: æ„å»ºå¹¶æ¨é€åˆ° GHCRï¼ˆå†…å­˜ä¼˜åŒ–ç‰ˆï¼‰

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write

    steps:
      # ===========================
      # 1. å‡†å¤‡ç¯å¢ƒ
      # ===========================
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ’¾ æ£€æŸ¥å¯ç”¨å†…å­˜
        run: |
          echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
          free -h
          df -h
          echo "=== Docker ä¿¡æ¯ ==="
          docker system df

      # ===========================
      # 2. è®¾ç½® Dockerï¼ˆå†…å­˜ä¼˜åŒ–ï¼‰
      # ===========================
      - name: ğŸ”§ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          # é™åˆ¶æ„å»ºå™¨ä½¿ç”¨çš„èµ„æº
          driver-opts: |
            image=moby/buildkit:latest
            network=host
          buildkitd-flags: |
            --oci-worker-gc --oci-worker-gc-keepstorage 1024

      # ===========================
      # 3. ç™»å½• GHCR
      # ===========================
      - name: ğŸ” ç™»å½•åˆ° GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ===========================
      # 4. ç”Ÿæˆé•œåƒæ ‡ç­¾
      # ===========================
      - name: ğŸ·ï¸ æå– Docker å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # main åˆ†æ”¯æ¨é€æ—¶æ‰“ latest æ ‡ç­¾
            type=raw,value=latest,enable={{is_default_branch}}
            # åˆ†æ”¯åæ ‡ç­¾
            type=ref,event=branch
            # PR ç¼–å·æ ‡ç­¾
            type=ref,event=pr
            # Git tag ç‰ˆæœ¬å·ï¼ˆv1.2.3 â†’ 1.2.3ï¼‰
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            # Git commit SHAï¼ˆmain-abc1234ï¼‰
            type=sha,prefix={{branch}}-,format=short
          labels: |
            org.opencontainers.image.title=Bot
            org.opencontainers.image.description=Telegram Bot Application
            org.opencontainers.image.vendor=artai8

      # ===========================
      # 5. æ¸…ç†ç©ºé—´ï¼ˆæ„å»ºå‰ï¼‰
      # ===========================
      - name: ğŸ§¹ æ¸…ç† Docker ç¼“å­˜
        run: |
          docker system prune -af --volumes
          docker buildx prune -af

      # ===========================
      # 6. æ„å»ºå¹¶æ¨é€ï¼ˆå•æ¶æ„ï¼Œå‡å°‘å†…å­˜ï¼‰
      # ===========================
      - name: ğŸ—ï¸ æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          # åªæ„å»º amd64 æ¶æ„ï¼ˆå‡å°‘ 50% å†…å­˜å ç”¨ï¼‰
          platforms: linux/amd64
          # PR æ—¶ä¸æ¨é€ï¼Œåªæ„å»ºæµ‹è¯•
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # ä½¿ç”¨è½»é‡çº§ç¼“å­˜ç­–ç•¥
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=min
          # ä¼˜åŒ–æ„å»ºå‚æ•°
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      # ===========================
      # 7. è¾“å‡ºæ„å»ºç»“æœ
      # ===========================
      - name: ğŸ“‹ è¾“å‡ºé•œåƒä¿¡æ¯
        if: github.event_name != 'pull_request'
        run: |
          echo "### ğŸ‰ é•œåƒæ„å»ºæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**é•œåƒåœ°å€ï¼š**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ‹‰å–å‘½ä»¤ï¼š**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**è¿è¡Œå‘½ä»¤ï¼š**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker run -d \\" >> $GITHUB_STEP_SUMMARY
          echo "  --name bot \\" >> $GITHUB_STEP_SUMMARY
          echo "  -p 8585:8585 \\" >> $GITHUB_STEP_SUMMARY
          echo "  -e BOT_TOKEN='your_token' \\" >> $GITHUB_STEP_SUMMARY
          echo "  --restart unless-stopped \\" >> $GITHUB_STEP_SUMMARY
          echo "  ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰€æœ‰æ ‡ç­¾ï¼š**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“¦ [æŸ¥çœ‹é•œåƒè¯¦æƒ…](https://github.com/${{ github.repository }}/pkgs/container/bot)" >> $GITHUB_STEP_SUMMARY

      # ===========================
      # 8. æµ‹è¯•é•œåƒï¼ˆå¯é€‰ï¼‰
      # ===========================
      - name: ğŸ§ª æµ‹è¯•é•œåƒ
        if: github.event_name != 'pull_request'
        run: |
          echo "=== æµ‹è¯•é•œåƒå¯åŠ¨ ==="
          docker run --rm -d --name test-bot \
            -p 8585:8585 \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 10
          
          echo "æ£€æŸ¥å®¹å™¨çŠ¶æ€..."
          docker ps -a
          
          echo "æ£€æŸ¥æ—¥å¿—..."
          docker logs test-bot
          
          echo "åœæ­¢æµ‹è¯•å®¹å™¨..."
          docker stop test-bot || true

      # ===========================
      # 9. æ¸…ç†ç©ºé—´ï¼ˆæ„å»ºåï¼‰
      # ===========================
      - name: ğŸ§¹ æ¸…ç†æ„å»ºç¼“å­˜
        if: always()
        run: |
          docker system prune -af
          echo "=== æ¸…ç†åçš„ç©ºé—´ ==="
          df -h
