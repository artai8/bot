name: ðŸ” GHCR æŽ¨é€è¯Šæ–­å·¥å…·

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main

permissions:
  contents: read
  packages: write
  actions: read

jobs:
  diagnose:
    runs-on: ubuntu-latest
    
    steps:
      # ===========================
      # 1. çŽ¯å¢ƒä¿¡æ¯æ”¶é›†
      # ===========================
      - name: ðŸ“Š æ”¶é›†ç³»ç»Ÿä¿¡æ¯
        run: |
          echo "## ðŸ–¥ï¸ ç³»ç»Ÿä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "Runner OS: $(uname -a)" >> $GITHUB_STEP_SUMMARY
          echo "Docker Version: $(docker --version)" >> $GITHUB_STEP_SUMMARY
          echo "Buildx Version: $(docker buildx version)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ’¾ èµ„æºçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          free -h >> $GITHUB_STEP_SUMMARY
          df -h >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      # ===========================
      # 2. GitHub ä¸Šä¸‹æ–‡ä¿¡æ¯
      # ===========================
      - name: ðŸ” æ£€æŸ¥ GitHub ä¸Šä¸‹æ–‡
        run: |
          echo "## ðŸ” GitHub ä¸Šä¸‹æ–‡" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo "Repository: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "Repository Owner: ${{ github.repository_owner }}" >> $GITHUB_STEP_SUMMARY
          echo "Actor: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "Event Name: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "Ref: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "SHA: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸŽ¯ ç›®æ ‡é•œåƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          IMAGE_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "Image Name (lowercase): ghcr.io/${IMAGE_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "Image Tag: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      # ===========================
      # 3. æ£€æŸ¥ GITHUB_TOKEN
      # ===========================
      - name: ðŸ”‘ éªŒè¯ GITHUB_TOKEN
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "## ðŸ”‘ Token éªŒè¯" >> $GITHUB_STEP_SUMMARY
          
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "âŒ GITHUB_TOKEN ä¸ºç©ºï¼" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… GITHUB_TOKEN å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
            echo "Token é•¿åº¦: ${#GITHUB_TOKEN} å­—ç¬¦" >> $GITHUB_STEP_SUMMARY
          fi
          
          # æµ‹è¯• token æƒé™
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æµ‹è¯• GitHub API è®¿é—®" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          response=$(curl -s -w "\n%{http_code}" -H "Authorization: token $GITHUB_TOKEN" \
            https://api.github.com/user)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "HTTP çŠ¶æ€ç : $http_code" >> $GITHUB_STEP_SUMMARY
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… API è®¿é—®æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "$body" | jq -r '.login' >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ API è®¿é—®å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "$body" >> $GITHUB_STEP_SUMMARY
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY

      # ===========================
      # 4. æ£€å‡ºä»£ç 
      # ===========================
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # ===========================
      # 5. è®¾ç½® Docker Buildx
      # ===========================
      - name: ðŸ”§ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ===========================
      # 6. ç™»å½•æµ‹è¯•ï¼ˆè¯¦ç»†æ—¥å¿—ï¼‰
      # ===========================
      - name: ðŸ” æµ‹è¯•ç™»å½• GHCRï¼ˆä½¿ç”¨ GITHUB_TOKENï¼‰
        id: login
        continue-on-error: true
        run: |
          echo "## ðŸ” ç™»å½•æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo "å°è¯•ç™»å½• ghcr.io..." >> $GITHUB_STEP_SUMMARY
          echo "ç”¨æˆ·å: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          
          if echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin 2>&1 | tee login.log; then
            echo "âœ… ç™»å½•æˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
            echo "login_success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ ç™»å½•å¤±è´¥ï¼" >> $GITHUB_STEP_SUMMARY
            echo "login_success=false" >> $GITHUB_OUTPUT
            cat login.log >> $GITHUB_STEP_SUMMARY
          fi
          
          echo '```' >> $GITHUB_STEP_SUMMARY

      # ===========================
      # 7. åˆ›å»ºæµ‹è¯• Dockerfile
      # ===========================
      - name: ðŸ“ åˆ›å»ºæµ‹è¯• Dockerfile
        run: |
          cat > Dockerfile.test <<EOF
          FROM alpine:3.19
          RUN echo "Test image for GHCR push diagnostics"
          CMD ["echo", "Hello from GHCR test"]
          EOF
          
          echo "## ðŸ“„ æµ‹è¯• Dockerfile" >> $GITHUB_STEP_SUMMARY
          echo '```dockerfile' >> $GITHUB_STEP_SUMMARY
          cat Dockerfile.test >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      # ===========================
      # 8. æž„å»ºæµ‹è¯•é•œåƒ
      # ===========================
      - name: ðŸ—ï¸ æž„å»ºæµ‹è¯•é•œåƒ
        id: build
        continue-on-error: true
        run: |
          echo "## ðŸ—ï¸ æž„å»ºé˜¶æ®µ" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          IMAGE_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_TAG="ghcr.io/${IMAGE_NAME}:test-$(date +%s)"
          
          echo "æž„å»ºé•œåƒ: $IMAGE_TAG" >> $GITHUB_STEP_SUMMARY
          
          if docker build -f Dockerfile.test -t "$IMAGE_TAG" . 2>&1 | tee build.log; then
            echo "âœ… æž„å»ºæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
            echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
            echo "build_success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ æž„å»ºå¤±è´¥ï¼" >> $GITHUB_STEP_SUMMARY
            echo "build_success=false" >> $GITHUB_OUTPUT
            cat build.log >> $GITHUB_STEP_SUMMARY
          fi
          
          echo '```' >> $GITHUB_STEP_SUMMARY

      # ===========================
      # 9. æŽ¨é€æµ‹è¯•ï¼ˆè¯¦ç»†é”™è¯¯æ—¥å¿—ï¼‰
      # ===========================
      - name: ðŸš€ æŽ¨é€æµ‹è¯•é•œåƒï¼ˆè¯¦ç»†æ—¥å¿—ï¼‰
        if: steps.login.outputs.login_success == 'true' && steps.build.outputs.build_success == 'true'
        id: push
        continue-on-error: true
        run: |
          echo "## ðŸš€ æŽ¨é€é˜¶æ®µ" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          IMAGE_TAG="${{ steps.build.outputs.image_tag }}"
          echo "æŽ¨é€é•œåƒ: $IMAGE_TAG" >> $GITHUB_STEP_SUMMARY
          
          # å¯ç”¨è¯¦ç»†æ—¥å¿—
          export DOCKER_BUILDKIT=1
          export BUILDKIT_PROGRESS=plain
          
          if docker push "$IMAGE_TAG" 2>&1 | tee push.log; then
            echo "âœ… æŽ¨é€æˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
            echo "push_success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ æŽ¨é€å¤±è´¥ï¼" >> $GITHUB_STEP_SUMMARY
            echo "push_success=false" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### è¯¦ç»†é”™è¯¯æ—¥å¿—ï¼š" >> $GITHUB_STEP_SUMMARY
            cat push.log >> $GITHUB_STEP_SUMMARY
          fi
          
          echo '```' >> $GITHUB_STEP_SUMMARY

      # ===========================
      # 10. ä½¿ç”¨ docker/build-push-action æµ‹è¯•
      # ===========================
      - name: ðŸ§ª ä½¿ç”¨å®˜æ–¹ Action æŽ¨é€æµ‹è¯•
        if: steps.login.outputs.login_success == 'true'
        id: action-push
        continue-on-error: true
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.test
          push: true
          tags: ghcr.io/${{ github.repository }}:action-test
          platforms: linux/amd64

      # ===========================
      # 11. æ£€æŸ¥æŽ¨é€ç»“æžœ
      # ===========================
      - name: ðŸ“Š æŽ¨é€ç»“æžœåˆ†æž
        if: always()
        run: |
          echo "## ðŸ“Š æµ‹è¯•ç»“æžœæ±‡æ€»" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "| æµ‹è¯•é¡¹ | ç»“æžœ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.login.outputs.login_success }}" = "true" ]; then
            echo "| GHCR ç™»å½• | âœ… æˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| GHCR ç™»å½• | âŒ å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.build.outputs.build_success }}" = "true" ]; then
            echo "| é•œåƒæž„å»º | âœ… æˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| é•œåƒæž„å»º | âŒ å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.push.outputs.push_success }}" = "true" ]; then
            echo "| æ‰‹åŠ¨æŽ¨é€ | âœ… æˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| æ‰‹åŠ¨æŽ¨é€ | âŒ å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.action-push.outcome }}" = "success" ]; then
            echo "| Action æŽ¨é€ | âœ… æˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Action æŽ¨é€ | âŒ å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi

      # ===========================
      # 12. æ£€æŸ¥å·²å­˜åœ¨çš„ Package æƒé™
      # ===========================
      - name: ðŸ” æ£€æŸ¥ Package æƒé™
        if: always()
        continue-on-error: true
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ æ£€æŸ¥çŽ°æœ‰ Package" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          PACKAGE_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          
          response=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/users/${{ github.repository_owner }}/packages/container/${PACKAGE_NAME}")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… Package å·²å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
            echo "$body" | jq '.' >> $GITHUB_STEP_SUMMARY
          elif [ "$http_code" = "404" ]; then
            echo "â„¹ï¸ Package ä¸å­˜åœ¨ï¼ˆé¦–æ¬¡æŽ¨é€ï¼‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ æ— æ³•æ£€æŸ¥ Packageï¼ˆHTTP $http_codeï¼‰" >> $GITHUB_STEP_SUMMARY
            echo "$body" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo '```' >> $GITHUB_STEP_SUMMARY

      # ===========================
      # 13. ä¸Šä¼ æ—¥å¿—æ–‡ä»¶
      # ===========================
      - name: ðŸ“¤ ä¸Šä¼ è¯Šæ–­æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ghcr-diagnostic-logs
          path: |
            login.log
            build.log
            push.log
          retention-days: 7

      # ===========================
      # 14. æœ€ç»ˆè¯Šæ–­æŠ¥å‘Š
      # ===========================
      - name: ðŸ“‹ ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ¯ ä¸‹ä¸€æ­¥æ“ä½œå»ºè®®" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.push.outputs.push_success }}" != "true" ]; then
            echo "### âŒ æŽ¨é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼š" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. **ä»“åº“æƒé™è®¾ç½®**" >> $GITHUB_STEP_SUMMARY
            echo "   - è®¿é—® https://github.com/${{ github.repository }}/settings/actions" >> $GITHUB_STEP_SUMMARY
            echo "   - ç¡®ä¿é€‰æ‹©äº† \`Read and write permissions\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "2. **æ£€æŸ¥ Workflow æƒé™**" >> $GITHUB_STEP_SUMMARY
            echo "   - ç¡®è®¤ workflow æ–‡ä»¶ä¸­æœ‰ \`packages: write\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "3. **å¦‚æžœ Package å·²å­˜åœ¨**" >> $GITHUB_STEP_SUMMARY
            echo "   - è®¿é—® https://github.com/users/${{ github.repository_owner }}/packages/container/bot/settings" >> $GITHUB_STEP_SUMMARY
            echo "   - åœ¨ \`Manage Actions access\` ä¸­æ·»åŠ ä»“åº“å¹¶æŽˆäºˆ Write æƒé™" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "4. **è€ƒè™‘ä½¿ç”¨ PAT**" >> $GITHUB_STEP_SUMMARY
            echo "   - åˆ›å»º https://github.com/settings/tokens/new" >> $GITHUB_STEP_SUMMARY
            echo "   - å‹¾é€‰ \`write:packages\` æƒé™" >> $GITHUB_STEP_SUMMARY
            echo "   - æ·»åŠ åˆ° https://github.com/${{ github.repository }}/settings/secrets/actions" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "å¯ä»¥å®‰å…¨ä½¿ç”¨åŽŸå§‹ workflow è¿›è¡ŒæŽ¨é€ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ è¯¦ç»†æ—¥å¿—å·²ä¿å­˜åˆ° Artifactsï¼Œä¸‹è½½æŸ¥çœ‹å®Œæ•´é”™è¯¯ä¿¡æ¯ã€‚" >> $GITHUB_STEP_SUMMARY
