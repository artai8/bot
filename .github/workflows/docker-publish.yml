name: æž„å»ºå¹¶æŽ¨é€åˆ° GHCRï¼ˆæžé™å†…å­˜ä¼˜åŒ–ç‰ˆï¼‰

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      # ===========================
      # 1. é‡Šæ”¾ç£ç›˜ç©ºé—´ï¼ˆé‡è¦ï¼ï¼‰
      # ===========================
      - name: ðŸ§¹ é‡Šæ”¾ç£ç›˜ç©ºé—´
        run: |
          echo "=== æ¸…ç†å‰ ==="
          df -h
          
          # åˆ é™¤ä¸éœ€è¦çš„è½¯ä»¶
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          
          # æ¸…ç† apt ç¼“å­˜
          sudo apt-get clean
          
          # æ¸…ç† Docker
          docker system prune -af --volumes
          
          echo "=== æ¸…ç†åŽ ==="
          df -h

      # ===========================
      # 2. æ£€å‡ºä»£ç 
      # ===========================
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # ===========================
      # 3. ç”Ÿæˆå°å†™é•œåƒå
      # ===========================
      - name: ðŸ”¤ ç”Ÿæˆé•œåƒä¿¡æ¯
        id: image
        run: |
          IMAGE_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ é•œåƒ: ${{ env.REGISTRY }}/${IMAGE_NAME}"

      # ===========================
      # 4. ç™»å½• GHCR
      # ===========================
      - name: ðŸ” ç™»å½• GHCR
        if: github.event_name != 'pull_request'
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      # ===========================
      # 5. æž„å»ºé•œåƒï¼ˆå†…å­˜ä¼˜åŒ–ï¼‰
      # ===========================
      - name: ðŸ—ï¸ æž„å»º Docker é•œåƒ
        run: |
          # ç¦ç”¨ BuildKit å¹¶è¡Œæž„å»ºï¼ˆå‡å°‘å†…å­˜ï¼‰
          export DOCKER_BUILDKIT=0
          
          # è®¾ç½®å†…å­˜é™åˆ¶
          IMAGE_TAG="${{ env.REGISTRY }}/${{ steps.image.outputs.name }}:${{ github.ref_name }}"
          LATEST_TAG="${{ env.REGISTRY }}/${{ steps.image.outputs.name }}:latest"
          
          echo "ðŸ”¨ å¼€å§‹æž„å»º..."
          echo "é•œåƒæ ‡ç­¾: ${IMAGE_TAG}"
          
          # å•çº¿ç¨‹æž„å»ºï¼Œå‡å°‘å†…å­˜å ç”¨
          docker build \
            --memory=900m \
            --memory-swap=1500m \
            --cpu-quota=100000 \
            --no-cache \
            --compress \
            --force-rm \
            --label "org.opencontainers.image.source=https://github.com/${{ github.repository }}" \
            --label "org.opencontainers.image.revision=${{ github.sha }}" \
            -t "${IMAGE_TAG}" \
            -t "${LATEST_TAG}" \
            .
          
          echo "âœ… æž„å»ºå®Œæˆ"
          docker images

      # ===========================
      # 6. æŽ¨é€é•œåƒ
      # ===========================
      - name: ðŸš€ æŽ¨é€é•œåƒ
        if: github.event_name != 'pull_request'
        run: |
          IMAGE_TAG="${{ env.REGISTRY }}/${{ steps.image.outputs.name }}:${{ github.ref_name }}"
          LATEST_TAG="${{ env.REGISTRY }}/${{ steps.image.outputs.name }}:latest"
          
          echo "ðŸ“¤ æŽ¨é€ ${IMAGE_TAG}..."
          docker push "${IMAGE_TAG}"
          
          # åªåœ¨ main/master åˆ†æ”¯æŽ¨é€ latest
          if [[ "${{ github.ref_name }}" == "main" || "${{ github.ref_name }}" == "master" ]]; then
            echo "ðŸ“¤ æŽ¨é€ ${LATEST_TAG}..."
            docker push "${LATEST_TAG}"
          fi
          
          echo "âœ… æŽ¨é€å®Œæˆ"

      # ===========================
      # 7. è¾“å‡ºç»“æžœ
      # ===========================
      - name: ðŸ“‹ è¾“å‡ºé•œåƒä¿¡æ¯
        if: github.event_name != 'pull_request'
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸŽ‰ é•œåƒæž„å»ºæˆåŠŸï¼

          **æ‹‰å–é•œåƒï¼š**
          \`\`\`bash
          docker pull ${{ env.REGISTRY }}/${{ steps.image.outputs.name }}:latest
          \`\`\`

          **è¿è¡Œå®¹å™¨ï¼š**
          \`\`\`bash
          docker run -d \\
            --name bot \\
            -p 8585:8585 \\
            -e BOT_TOKEN='your_token' \\
            --restart unless-stopped \\
            ${{ env.REGISTRY }}/${{ steps.image.outputs.name }}:latest
          \`\`\`

          **é•œåƒæ ‡ç­¾ï¼š**
          - \`${{ env.REGISTRY }}/${{ steps.image.outputs.name }}:${{ github.ref_name }}\`
          - \`${{ env.REGISTRY }}/${{ steps.image.outputs.name }}:latest\`

          ðŸ“¦ [æŸ¥çœ‹é•œåƒ](https://github.com/${{ github.repository }}/pkgs/container/bot)
          EOF

      # ===========================
      # 8. æ¸…ç†
      # ===========================
      - name: ðŸ§¹ æ¸…ç†
        if: always()
        run: |
          docker system prune -af
